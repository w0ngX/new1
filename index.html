{% extends "base.html" %}

{% block content %}
<div class="mb-4">
    <h3>æ¬¢è¿å›æ¥ï¼Œ{{ current_user.username }}ï¼</h3>
    <p class="text-muted">è¿™æ˜¯ç³»ç»Ÿç›®å‰çš„æ•°æ®æ¦‚å†µã€‚</p>
</div>
<div class="row justify-content-center mb-4 mt-5">
    <div class="col-md-8">
        <div class="text-center mb-3">
            <h2 class="mb-3">ğŸ‘‹ æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„æ•°æ®åŠ©æ‰‹</h2>
        </div>

        <div class="input-group input-group-lg shadow-sm mb-3">
            <span class="input-group-text bg-white border-end-0">
                <i class="bi bi-robot text-primary"></i>
            </span>
            <input type="text" class="form-control border-start-0"
                   id="dashInput"
                   placeholder="åœ¨æ­¤ç›´æ¥æé—®ï¼Œç»“æœå°†æ˜¾ç¤ºåœ¨ä¸‹æ–¹..."
                   onkeypress="handleDashEnter(event)">
            <button class="btn btn-primary px-4" type="button" onclick="startDashSearch()">
                <i class="bi bi-search"></i> æŸ¥è¯¢
            </button>
        </div>

        <div id="dashResultCard" class="card shadow-sm border-0 bg-light" style="display: none;">
            <div class="card-header bg-white border-bottom-0 d-flex justify-content-between align-items-center">
                <strong class="text-primary"><i class="bi bi-stars"></i> AI å›ç­”ï¼š</strong>
                <button class="btn btn-sm btn-link text-muted text-decoration-none" onclick="closeDashResult()">
                    <i class="bi bi-x-lg"></i> å…³é—­
                </button>
            </div>
            <div class="card-body">
                <div id="dashOutput" class="text-dark" style="line-height: 1.6; font-size: 1.05rem;"></div>

                <div id="dashLoading" class="mt-2 text-muted small" style="display: none;">
                    <span class="spinner-border spinner-border-sm" role="status"></span> æ­£åœ¨æ€è€ƒä¸­...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function handleDashEnter(e) {
        if (e.key === 'Enter') startDashSearch();
    }

    function closeDashResult() {
        document.getElementById('dashResultCard').style.display = 'none';
        document.getElementById('dashInput').value = '';
    }

    async function startDashSearch() {
        const input = document.getElementById('dashInput');
        const output = document.getElementById('dashOutput');
        const card = document.getElementById('dashResultCard');
        const loading = document.getElementById('dashLoading');

        const query = input.value.trim();
        if (!query) return;

        // 1. åˆå§‹åŒ–ç•Œé¢çŠ¶æ€
        card.style.display = 'block'; // æ˜¾ç¤ºç»“æœå¡ç‰‡
        output.innerHTML = '';        // æ¸…ç©ºæ—§å†…å®¹
        loading.style.display = 'block'; // æ˜¾ç¤ºåŠ è½½ä¸­

        // 2. å‘èµ·è¯·æ±‚ (ä¸æ‚¬æµ®çƒä½¿ç”¨åŒä¸€ä¸ªåç«¯æ¥å£)
        try {
            const response = await fetch('/api/ai_query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });

            // 3. å‡†å¤‡è¯»å–æµ
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullText = "";

            // éšè— loadingï¼Œå¼€å§‹æ˜¾ç¤ºæ–‡å­—
            loading.style.display = 'none';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonStr = line.slice(6);
                        if (jsonStr.trim() === '[DONE]') break;

                        try {
                            const data = JSON.parse(jsonStr);
                            if (data.text) {
                                fullText += data.text;
                                // ç®€å•æ¢è¡Œå¤„ç†
                                output.innerHTML = fullText.replace(/\n/g, '<br>');
                            }
                        } catch (e) { console.error(e); }
                    }
                }
            }

        } catch (err) {
            loading.style.display = 'none';
            output.innerHTML = `<span class="text-danger">æŸ¥è¯¢å‡ºé”™: ${err.message}</span>`;
        }
    }
</script>
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-light border-0">
            <div class="card-body d-flex justify-content-between align-items-center">
                <span class="fw-bold text-muted">ğŸš€ å¿«é€Ÿæ“ä½œå…¥å£ï¼š</span>
                <div>
                    <a href="{{ url_for('edit_contract', id=0) }}" class="btn btn-sm btn-primary rounded-pill px-3 me-2">+ æ–°å¢åˆåŒ</a>
                    <a href="{{ url_for('edit_topic', id=0) }}" class="btn btn-sm btn-success rounded-pill px-3 me-2">+ æ–°å¢ä¸»é¢˜</a>
                    <a href="{{ url_for('edit_task', id=0) }}" class="btn btn-sm btn-warning rounded-pill px-3 me-2">+ æ–°å¢æœåŠ¡</a>
                    <a href="{{ url_for('service_mapping', action='add') }}" class="btn btn-sm btn-info text-white rounded-pill px-3 me-2">
                        <i class="bi bi-diagram-3"></i> æ–°å¢å¯¹åº”å…³ç³»
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- ================= åˆåŒçŠ¶æ€åˆ†æ ================= -->
<div class="row mt-2">
    <div class="col-md-12">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0"><i class="bi bi-pie-chart-fill text-primary me-2"></i>åˆåŒæ¨¡å—åˆ†æ</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between">
                            <h6 class="fw-bold mb-3">å±¥çº¦ä¸­åˆåŒå æ¯”</h6>
                            <span class="fw-bold ">æ€»è®¡ {{ total_contracts }} ä»½åˆåŒ</span>
                        </div>

                        <div class="mt-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-success">
                                    <i class="bi bi-caret-up-fill me-1"></i> å±¥çº¦ä¸­
                                </span>
                                <span class="fw-bold text-success">{{ active_contracts }} ä»½</span>
                            </div>
                            <!--<div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar"
                                     style="width: {{ active_percent }}%"></div>
                            </div>-->
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-secondary">
                                    <i class="bi bi-check-circle-fill me-1"></i> å·²ç»“æŸ
                                </span>
                                <span class="fw-bold text-secondary">{{ ended_contracts }} ä»½</span>
                            </div>
                            <!--<div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-secondary" role="progressbar"
                                     style="width: {{ ended_percent }}%"></div>
                            </div>-->
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="border-start ps-4">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <h6 class="fw-bold mb-3">åˆåŒé‡‘é¢åˆ†å¸ƒ</h6>
                                    <span class="fw-bold ">{{ unsettled_count }}/{{ total_contracts }} ä»½åˆåŒå¾…ä»˜</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>åˆåŒæ€»é‡‘é¢</span>
                                    <span class=" text-muted">Â¥{{ "{:,.2f}".format(total_amount) }}</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span class="text-danger">å¾…ç»“ç®—é‡‘é¢</span>
                                    <span class="fw-bold text-danger">Â¥{{ "{:,.2f}".format(unsettled_amount) }}</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ================= é‡ç‚¹ç¨åŠ¡åˆåŒç›‘æ§ï¼ˆç»Ÿä¸€æ¨¡å—ï¼‰ ================= -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        <i class="bi bi-search-heart text-info me-2"></i>
                        é‡ç‚¹ç¨åŠ¡åˆåŒç›‘æ§
                        <small class="text-muted" id="contract-type-label">(å…¨éƒ¨ç¨åŠ¡åˆåŒä¸”å±¥çº¦ä¸­)</small>
                    </h5>
                </div>
                <div class="d-flex align-items-center">
                    <!-- åˆ‡æ¢å¼€å…³ -->
                    <div class="btn-group btn-group-sm me-3" role="group">
                        <input type="radio" class="btn-check" name="contract-type" id="all-type" autocomplete="off" checked onclick="switchContractType('all')">
                        <label class="btn btn-outline-primary" for="all-type">å…¨éƒ¨</label>

                        <input type="radio" class="btn-check" name="contract-type" id="jsb-type" autocomplete="off" onclick="switchContractType('jsb')">
                        <label class="btn btn-outline-primary" for="jsb-type">ææ•°å®</label>

                        <input type="radio" class="btn-check" name="contract-type" id="mf-type" autocomplete="off" onclick="switchContractType('mf')">
                        <label class="btn btn-outline-primary" for="mf-type">èš‚èœ‚</label>
                    </div>

                    <span class="badge bg-info bg-opacity-10 text-info px-3 py-2" id="contract-count-badge">
                        <i class="bi bi-file-earmark-text me-1"></i>
                        <span id="contract-count">{{ important_count }}</span> ä»½
                    </span>
                </div>
            </div>

            <div class="card-body p-0">
                <!-- å…¨éƒ¨ç¨åŠ¡åˆåŒè¡¨æ ¼ -->
                <div id="all-table-section" class="contract-table-section">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa;">
                                <tr class="table-light">
                                    <th class="border-0 ps-4" style="width: 15%;">åˆåŒç¼–å·</th>
                                    <th class="border-0" style="width: 35%;">åˆåŒåç§°</th>
                                    <th class="border-0" style="width: 20%;">ç”²æ–¹å•ä½</th>
                                    <th class="border-0" style="width: 20%;">ç±»å‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if important_contracts %}
                                    {% for c in important_contracts %}
                                    <tr class="align-middle">
                                        <td class="ps-4">
                                            <span class="fw-semibold">{{ c.contract_code or 'æœªç¼–å·' }}</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <a href="{{ url_for('edit_contract', id=c.id) }}"
                                                   class="text-decoration-none text-dark hover-primary">
                                                    {{ c.name|truncate(40) }}
                                                </a>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="text-muted">{{ c.party_a|default('æœªå¡«å†™', true)|truncate(25) }}</span>
                                        </td>
                                        <td>
                                            {% if c.party_b and 'èš‚èœ‚' in c.party_b %}
                                                <span class="badge bg-warning bg-opacity-10 text-warning">èš‚èœ‚</span>
                                            {% elif c.party_b and 'ææ•°å®' in c.party_b %}
                                                <span class="badge bg-primary bg-opacity-10 text-primary">ææ•°å®</span>
                                            {% else %}
                                                <span class="badge bg-info bg-opacity-10 text-info">ç¨åŠ¡</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center py-5 text-muted">
                                            <i class="bi bi-inbox fs-1 opacity-50"></i>
                                            <p class="mt-2">æš‚æ— ç¬¦åˆæ¡ä»¶çš„ç¨åŠ¡åˆåŒ</p>
                                            <a href="{{ url_for('contracts') }}" class="btn btn-sm btn-outline-primary mt-2">
                                                æŸ¥çœ‹æ‰€æœ‰åˆåŒ
                                            </a>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- å…¨éƒ¨åˆåŒåº•éƒ¨ç»Ÿè®¡ä¿¡æ¯ -->
                    {% if important_contracts %}
                    <div class="border-top bg-light px-4 py-3">
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    æ”¯æŒé¼ æ ‡æ»šåŠ¨æŸ¥çœ‹
                                </small>
                            </div>
                            <div class="col-md-8 text-end">
                                <small class="text-muted">
                                    <span class="me-3">
                                        æ€»é‡‘é¢: <strong>Â¥{{ "{:,.2f}".format(important_contracts|sum(attribute='amount')) }}</strong>
                                    </span>
                                    <span>
                                        å¹³å‡é‡‘é¢: <strong>Â¥{{ "{:,.2f}".format((important_contracts|sum(attribute='amount'))/important_count if important_count > 0 else 0) }}</strong>
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- ææ•°å®åˆåŒè¡¨æ ¼ -->
                <div id="jsb-table-section" class="contract-table-section" style="display: none;">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa;">
                                <tr class="table-light">
                                    <th class="border-0 ps-4" style="width: 15%;">åˆåŒç¼–å·</th>
                                    <th class="border-0" style="width: 35%;">åˆåŒåç§°</th>
                                    <th class="border-0" style="width: 20%;">ç”²æ–¹å•ä½</th>
                                    <th class="border-0" style="width: 20%;">ç±»å‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if jsb_contracts %}
                                    {% for c in jsb_contracts %}
                                    <tr class="align-middle">
                                        <td class="ps-4">
                                            <span class="fw-semibold">{{ c.contract_code or 'æœªç¼–å·' }}</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <a href="{{ url_for('edit_contract', id=c.id) }}"
                                                   class="text-decoration-none text-dark hover-primary">
                                                    {{ c.name|truncate(40) }}
                                                </a>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="text-muted">{{ c.party_a|default('æœªå¡«å†™', true)|truncate(25) }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary bg-opacity-10 text-primary">ææ•°å®</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center py-5 text-muted">
                                            <i class="bi bi-inbox fs-1 opacity-50"></i>
                                            <p class="mt-2">æš‚æ— ç¬¦åˆæ¡ä»¶çš„ææ•°å®åˆåŒ</p>
                                            <a href="{{ url_for('contracts') }}" class="btn btn-sm btn-outline-primary mt-2">
                                                æŸ¥çœ‹æ‰€æœ‰åˆåŒ
                                            </a>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- ææ•°å®åº•éƒ¨ç»Ÿè®¡ä¿¡æ¯ -->
                    {% if jsb_contracts %}
                    <div class="border-top bg-light px-4 py-3">
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    æ”¯æŒé¼ æ ‡æ»šåŠ¨æŸ¥çœ‹
                                </small>
                            </div>
                            <div class="col-md-8 text-end">
                                <small class="text-muted">
                                    <span class="me-3">
                                        æ€»é‡‘é¢: <strong>Â¥{{ "{:,.2f}".format(jsb_contracts|sum(attribute='amount')) }}</strong>
                                    </span>
                                    <span>
                                        å¹³å‡é‡‘é¢: <strong>Â¥{{ "{:,.2f}".format((jsb_contracts|sum(attribute='amount'))/jsb_count if jsb_count > 0 else 0) }}</strong>
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- èš‚èœ‚åˆåŒè¡¨æ ¼ -->
                <div id="mf-table-section" class="contract-table-section" style="display: none;">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa;">
                                <tr class="table-light">
                                    <th class="border-0 ps-4" style="width: 15%;">åˆåŒç¼–å·</th>
                                    <th class="border-0" style="width: 35%;">åˆåŒåç§°</th>
                                    <th class="border-0" style="width: 20%;">ç”²æ–¹å•ä½</th>
                                    <th class="border-0" style="width: 20%;">ç±»å‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if mf_contracts %}
                                    {% for c in mf_contracts %}
                                    <tr class="align-middle">
                                        <td class="ps-4">
                                            <span class="fw-semibold">{{ c.contract_code or 'æœªç¼–å·' }}</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <a href="{{ url_for('edit_contract', id=c.id) }}"
                                                   class="text-decoration-none text-dark hover-primary">
                                                    {{ c.name|truncate(40) }}
                                                </a>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="text-muted">{{ c.party_a|default('æœªå¡«å†™', true)|truncate(25) }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-warning bg-opacity-10 text-warning">èš‚èœ‚</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center py-5 text-muted">
                                            <i class="bi bi-inbox fs-1 opacity-50"></i>
                                            <p class="mt-2">æš‚æ— ç¬¦åˆæ¡ä»¶çš„èš‚èœ‚åˆåŒ</p>
                                            <a href="{{ url_for('contracts') }}" class="btn btn-sm btn-outline-primary mt-2">
                                                æŸ¥çœ‹æ‰€æœ‰åˆåŒ
                                            </a>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>

                    <!-- èš‚èœ‚åº•éƒ¨ç»Ÿè®¡ä¿¡æ¯ -->
                    {% if mf_contracts %}
                    <div class="border-top bg-light px-4 py-3">
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    æ”¯æŒé¼ æ ‡æ»šåŠ¨æŸ¥çœ‹
                                </small>
                            </div>
                            <div class="col-md-8 text-end">
                                <small class="text-muted">
                                    <span class="me-3">
                                        æ€»é‡‘é¢: <strong>Â¥{{ "{:,.2f}".format(mf_contracts|sum(attribute='amount')) }}</strong>
                                    </span>
                                    <span>
                                        å¹³å‡é‡‘é¢: <strong>Â¥{{ "{:,.2f}".format((mf_contracts|sum(attribute='amount'))/mf_count if mf_count > 0 else 0) }}</strong>
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ‡æ¢åˆåŒç±»å‹çš„JavaScript -->
<script>
    function switchContractType(type) {
        // åˆ‡æ¢æ ‡ç­¾æ–‡æœ¬
        const label = document.getElementById('contract-type-label');
        const countBadge = document.getElementById('contract-count');

        if (type === 'all') {
            label.textContent = '(å…¨éƒ¨ç¨åŠ¡åˆåŒä¸”å±¥çº¦ä¸­)';
            countBadge.textContent = '{{ important_count }}';

            // æ˜¾ç¤ºå…¨éƒ¨è¡¨æ ¼ï¼Œéšè—å…¶ä»–è¡¨æ ¼
            document.getElementById('all-table-section').style.display = 'block';
            document.getElementById('jsb-table-section').style.display = 'none';
            document.getElementById('mf-table-section').style.display = 'none';
        } else if (type === 'jsb') {
            label.textContent = '(ææ•°å®ä¸”å±¥çº¦ä¸­)';
            countBadge.textContent = '{{ jsb_count }}';

            // æ˜¾ç¤ºææ•°å®è¡¨æ ¼ï¼Œéšè—å…¶ä»–è¡¨æ ¼
            document.getElementById('all-table-section').style.display = 'none';
            document.getElementById('jsb-table-section').style.display = 'block';
            document.getElementById('mf-table-section').style.display = 'none';
        } else if (type === 'mf') {
            label.textContent = '(èš‚èœ‚ä¸”å±¥çº¦ä¸­)';
            countBadge.textContent = '{{ mf_count }}';

            // æ˜¾ç¤ºèš‚èœ‚è¡¨æ ¼ï¼Œéšè—å…¶ä»–è¡¨æ ¼
            document.getElementById('all-table-section').style.display = 'none';
            document.getElementById('jsb-table-section').style.display = 'none';
            document.getElementById('mf-table-section').style.display = 'block';
        }
    }
</script>

<!-- æ·»åŠ ä¸€äº›è‡ªå®šä¹‰æ ·å¼ -->
<style>
    .hover-primary:hover {
        color: #0d6efd !important;
    }

    /* ç¾åŒ–æ»šåŠ¨æ¡ */
    .table-responsive::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* è¡¨æ ¼è¡Œæ‚¬åœæ•ˆæœ */
    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    /* å›ºå®šè¡¨å¤´é˜´å½± */
    thead.table-light {
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* åˆåŒç±»å‹åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    .btn-group .btn-outline-primary.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    .contract-table-section {
        transition: opacity 0.3s ease;
    }

    /* ç±»å‹æ ‡ç­¾æ ·å¼ */
    .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
</style>

{% endblock %}