{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">æœåŠ¡å†…å®¹ <small class="text-muted fs-6">(å…± {{ pagination.total }} æ¡)</small></h3>
    <div>
        <button type="button" class="btn btn-danger btn-sm me-1" id="btnBatchDelete" onclick="submitBatchDelete()" disabled>
            <i class="bi bi-trash"></i> æ‰¹é‡åˆ é™¤ <span id="selectCountText"></span>
        </button>
        <button type="button" class="btn btn-outline-success btn-sm me-1" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="bi bi-file-earmark-excel"></i> å¯¼å…¥æœåŠ¡å†…å®¹
        </button>
        <a href="{{ url_for('edit_task', id=0) }}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-lg"></i> æ–°å¢æœåŠ¡
        </a>
    </div>
</div>

<div class="card bg-light mb-3">
    <div class="card-body py-2">
        <form method="GET" class="row g-2 align-items-center">
            <div class="col-auto">
                <input type="text" name="contract_code" class="form-control form-control-sm" placeholder="åˆåŒç¼–å·..." value="{{ request.args.get('contract_code', '') }}" >
            </div>
            <div class="col-auto">
                <input type="text" name="contract_name" class="form-control form-control-sm" placeholder="åˆåŒåç§°..." value="{{ request.args.get('contract_name', '') }}">
            </div>

            <div class="col-auto">
                <input type="text" name="party_a" class="form-control form-control-sm" placeholder="ç”²æ–¹å•ä½..." value="{{ request.args.get('party_a', '') }}" >
            </div>
            <div class="col-auto">
                <input type="text" name="party_b" class="form-control form-control-sm" placeholder="ä¹™æ–¹å•ä½..." value="{{ request.args.get('party_b', '') }}" >
            </div>
            <div class="col-auto">
                <input type="text" name="service_content" class="form-control form-control-sm" placeholder="æœåŠ¡å†…å®¹..." value="{{ request.args.get('service_content', '') }}">
            </div>
            <div class="col-auto">
                <input type="text" name="theme_name" class="form-control form-control-sm" placeholder="ä¸»é¢˜åç§°..." value="{{ request.args.get('theme_name', '') }}">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-secondary">ğŸ” æŸ¥è¯¢</button>
                <a href="{{ url_for('tasks') }}" class="btn btn-sm btn-outline-secondary">é‡ç½®</a>
            </div>
        </form>
    </div>
</div>

<form id="batchForm" action="{{ url_for('batch_delete_tasks') }}" method="POST">
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width: 40px;" class="text-center">
                        <input type="checkbox" id="selectAll" class="form-check-input">
                    </th>
                    <th style="width: 60px;">åºå·</th>
                    <th>åˆåŒåç§°</th>
                    <th>æœåŠ¡å†…å®¹</th>
                    <th>ä¸»é¢˜åç§°</th>
                    <th style="width: 150px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for task in pagination.items %}
                <tr>
                    <td class="text-center">
                        <input type="checkbox" name="selected_ids" value="{{ task.id }}" class="form-check-input item-checkbox">
                    </td>
                    <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                    <td>
                        <div class="fw-bold">
                            {{ task.contract.name }}
                        </div>
                        <div >
                        {% if task.contract %}
                            <div class="small text-muted" style="font-size: 0.85em; margin-top: 4px;">
                                <span title="åˆåŒç¼–å·" class="small text-muted">
                                    ğŸ“{{ task.contract.contract_code }}
                                </span>
                                <span class="mx-1">|</span>
                                <span title="ç”²æ–¹å•ä½"> {{ task.contract.party_a }}</span>
                                <span class="mx-1">|</span>
                                <span title="ä¹™æ–¹å•ä½"> {{ task.contract.party_b }}</span>
                            </div>
                        {% else %}
                            <span class="badge bg-warning text-dark">æœªå…³è”åˆåŒ</span>
                        {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 300px;" title="{{ task.service_content }}">
                            {{ task.service_content }}
                        </div>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 300px;" title="{{ task.theme_name }}">
                            {{ task.theme_name }}
                        </div>

                        {% set tid = topic_map.get(task.theme_name) %}

                        {% if tid %}
                            <div class="small mt-1" style="font-size: 0.85em;">
                                ğŸ†”{{ tid }}
                            </div>

                        {% elif task.theme_name %}
                            <div class="small text-muted mt-1 fst-italic" style="font-size: 0.8em;">
                                (æœªåŒ¹é…åˆ°ID)
                            </div>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('edit_task', id=task.id) }}" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a>
                            <a href="{{ url_for('delete_task', id=task.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ');">åˆ é™¤</a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">æš‚æ— æœåŠ¡æ•°æ®</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>

<nav class="mt-4">
    <div class="d-flex justify-content-center align-items-center flex-wrap gap-3">
        <ul class="pagination mb-0">
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('tasks', page=pagination.prev_num, contract_name=request.args.get('contract_name', ''), theme_name=request.args.get('theme_name', '')) }}">
                    <i class="bi bi-chevron-left"></i> ä¸Šä¸€é¡µ
                </a>
            </li>
            {% endif %}

            <li class="page-item active">
                <span class="page-link">ç¬¬ {{ pagination.page }} é¡µ / å…± {{ pagination.pages }} é¡µ</span>
            </li>

            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('tasks', page=pagination.next_num, contract_name=request.args.get('contract_name', ''), theme_name=request.args.get('theme_name', '')) }}">
                    ä¸‹ä¸€é¡µ <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
        <div class="d-flex align-items-center">
            <span class="me-2 text-muted small">è·³è½¬è‡³</span>
            <input type="number" id="jumpPageInput" class="form-control form-control-sm text-center" style="width: 60px;" min="1" max="{{ pagination.pages }}" value="{{ pagination.page }}">
            <span class="ms-2 me-2 text-muted small">é¡µ</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="jumpToPage()">ç¡®å®š</button>
        </div>
    </div>
</nav>
<!---å¯¼å…¥æœåŠ¡æ¨¡æ€æ¡†--->
<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-file-earmark-excel-fill me-2"></i>æ‰¹é‡å¯¼å…¥æœåŠ¡å†…å®¹</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form action="{{ url_for('import_task_excel') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body p-4">
                    <div class="row g-4">

                        <div class="col-lg-5">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="fw-bold text-success mb-3">
                                        <i class="bi bi-list-check me-1"></i> ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æ•°æ®è§„èŒƒ
                                    </h6>
                                    <ul class="list-group list-group-flush bg-transparent small">
                                        <li class="list-group-item bg-transparent px-0">
                                            <span class="badge bg-danger me-2">å¿…å¡«</span>
                                            <strong>åˆåŒåç§°ã€æœåŠ¡å†…å®¹ã€ä¸»é¢˜åç§°</strong>
                                        </li>
                                        <li class="list-group-item bg-transparent px-0">
                                            <i class="bi bi-link-45deg text-primary me-1"></i>
                                            <strong>è‡ªåŠ¨å…³è”ï¼š</strong>ç³»ç»Ÿä¼šæ ¹æ®â€œåˆåŒåç§°â€è‡ªåŠ¨æŸ¥æ‰¾å¹¶å…³è”å·²æœ‰åˆåŒã€‚è¯·ç¡®ä¿åç§°å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬æ‹¬å·ã€ç©ºæ ¼ï¼‰ã€‚
                                        </li>
                                        <li class="list-group-item bg-transparent px-0">
                                            <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                                            <strong>æ³¨æ„ï¼š</strong>å¦‚æœåˆåŒåç§°åœ¨ç³»ç»Ÿä¸­ä¸å­˜åœ¨ï¼Œè¯¥æœåŠ¡å†…å®¹å°†æ˜¾ç¤ºä¸ºâ€œæœªå…³è”åˆåŒâ€ã€‚
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-7">
                            <div class="border rounded p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold text-primary m-0">
                                        <i class="bi bi-table me-1"></i> æ¨¡æ¿æ ¼å¼é¢„è§ˆ
                                    </h6>
                                    <a href="{{ url_for('download_task_template') }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-download me-1"></i> ä¸‹è½½æ ‡å‡† Excel æ¨¡æ¿
                                    </a>
                                </div>

                                <div class="table-responsive border rounded bg-white" style="font-size: 12px;">
                                    <table class="table table-bordered table-sm mb-0 text-center text-nowrap">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="text-danger">åˆåŒåç§°*</th>
                                                <th class="text-danger">æœåŠ¡å†…å®¹*</th>
                                                <th class="text-danger">ä¸»é¢˜åç§°*</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>XXçœæ•°æ®é‡‡è´­é¡¹ç›®</td>
                                                <td>æä¾›å…¨çœé«˜æ ¡ç§‘ç ”æ•°æ®...</td>
                                                <td>ç§‘ç ”æ•°æ®</td>
                                            </tr>
                                            <tr>
                                                <td>æ™ºæ…§åŸå¸‚å»ºè®¾åˆåŒ</td>
                                                <td>æä¾›å®æ—¶æ°´è´¨ç›‘æµ‹API...</td>
                                                <td>æ°´è´¨ç›‘æµ‹</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">...</td>
                                                <td class="text-muted">...</td>
                                                <td class="text-muted">...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="form-text mt-2 text-muted">
                                    <small>* çº¢è‰²æ ‡é¢˜ä¸ºå¿…å¡«åˆ—ï¼Œè¯·å‹¿ä¿®æ”¹æ¨¡æ¿è¡¨å¤´ã€‚</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="row justify-content-center">
                        <div class="col-lg-8 text-center">
                            <h6 class="fw-bold mb-3">ç¬¬äºŒæ­¥ï¼šä¸Šä¼ å¡«å†™å¥½çš„æ–‡ä»¶</h6>
                            <div class="input-group input-group-lg">
                                <input type="file" class="form-control" name="file" accept=".xlsx, .xls" required>
                                <button type="submit" class="btn btn-success px-5">
                                    <i class="bi bi-cloud-upload-fill me-1"></i> ç¡®è®¤å¯¼å…¥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // --- åˆ†é¡µè·³è½¬ ---
    function jumpToPage() {
        const pageNum = document.getElementById('jumpPageInput').value;
        const maxPage = {{ pagination.pages }};
        if (pageNum >= 1 && pageNum <= maxPage) {
            const url = new URL(window.location.href);
            url.searchParams.set('page', pageNum);
            window.location.href = url.pathname + url.search;
        } else { alert(`è¯·è¾“å…¥ 1 åˆ° ${maxPage} ä¹‹é—´çš„é¡µç `); }
    }
    document.getElementById('jumpPageInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') jumpToPage();
    });

    // --- æ‰¹é‡åˆ é™¤é€»è¾‘ ---
    function submitBatchDelete() {
        var len = document.querySelectorAll('.item-checkbox:checked').length;
        if (len === 0) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹ï¼'); return; }
        if (confirm('ç¡®å®šè¦æ‰¹é‡åˆ é™¤é€‰ä¸­çš„ ' + len + ' é¡¹æœåŠ¡å—ï¼Ÿ')) {
            // æäº¤ id="batchForm"
            document.getElementById('batchForm').submit();
        }
    }

    // --- å…¨é€‰ä¸æŒ‰é’®è”åŠ¨ ---
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        const btnBatchDelete = document.getElementById('btnBatchDelete');
        const selectCountText = document.getElementById('selectCountText');

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateBatchButton() {
            const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
            if (checkedCount > 0) {
                btnBatchDelete.disabled = false;
                selectCountText.innerText = '(' + checkedCount + ')';
            } else {
                btnBatchDelete.disabled = true;
                selectCountText.innerText = '';
            }
        }

        // å…¨é€‰äº‹ä»¶
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                itemCheckboxes.forEach(cb => cb.checked = isChecked);
                updateBatchButton();
            });
        }

        // å•é€‰äº‹ä»¶
        itemCheckboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                updateBatchButton();
                if (!this.checked && selectAllCheckbox) selectAllCheckbox.checked = false;
            });
        });
    });
</script>
{% endblock %}