{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <h3 class="mb-3"><i class="bi bi-list-check text-primary"></i> ä»»åŠ¡ç®¡ç†ä¸­å¿ƒ</h3>

            <ul class="nav nav-tabs" id="taskTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-gen-btn" data-bs-toggle="tab" data-bs-target="#tab-gen" type="button">
                        <i class="bi bi-magic"></i> ä»»åŠ¡ç”Ÿæˆ
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-view-btn" data-bs-toggle="tab" data-bs-target="#tab-view" type="button">
                        <i class="bi bi-eye"></i> ä»»åŠ¡æŸ¥çœ‹
                        {% if ongoing_count > 0 %}
                        <span class="badge bg-danger rounded-pill ms-1">{{ ongoing_count }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-stat-btn" data-bs-toggle="tab" data-bs-target="#tab-stat" type="button">
                        <i class="bi bi-bar-chart-line"></i> ä»»åŠ¡ç»Ÿè®¡
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="tab-content" id="taskTabsContent">

        <div class="tab-pane fade show active" id="tab-gen" role="tabpanel">
            <div class="card border-top-0 rounded-0 shadow-sm">
                <div class="card-body">
                    <div class="card bg-light mb-3">
                        <div class="card-body py-3">
                            <form method="GET" action="{{ url_for('task_management') }}" class="row g-3 align-items-center">
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                        <input type="text" name="q" class="form-control"
                                               placeholder="è¾“å…¥ä¸»é¢˜åç§° / åˆåŒç¼–å·...ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰"
                                               value="{{ request.args.get('q', '') }}">
                                        <button type="submit" class="btn btn-primary px-4">æœç´¢</button>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button type="button" class="btn btn-success" onclick="openBatchModal()">
                                        <i class="bi bi-collection-play-fill"></i> æ‰¹é‡ç”Ÿæˆä»»åŠ¡
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    {% if request.args.get('q') %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px;" class="text-center">
                                        <input type="checkbox" class="form-check-input" id="checkAll" onchange="toggleAll(this)">
                                    </th>
                                    <th style="width: 60px;" class="text-center">åºå·</th>
                                    <th>é€‰é¡¹å†…å®¹ (åˆåŒ - æœåŠ¡ - ä¸»é¢˜)</th>
                                    <th style="width: 150px;" class="text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in results %}
                                <tr>
                                    <td class="text-center">
                                        <input type="checkbox" class="form-check-input task-check"
                                               value="{{ item.id }}"
                                               data-contract="{{ item.contract_name }}"
                                               data-theme="{{ item.theme_name }}"
                                               data-owner="{{ item.owner }}"
                                               data-frequency="{{ item.frequency }}">
                                    </td>
                                    <td class="text-center">{{ loop.index }}</td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="fw-bold text-dark mb-1">
                                                <i class="bi bi-file-text me-1 text-secondary"></i> {{ item.contract_name }}
                                            </span>
                                            <span class="text-muted small ps-3">
                                                <i class="bi bi-arrow-return-right me-1"></i> {{ item.service_content }}
                                            </span>
                                            <span class="text-primary small ps-5">
                                                <i class="bi bi-tag-fill"></i> {{ item.theme_name }}
                                                {% if item.owner %}
                                                <span class="badge bg-light text-secondary border ms-2">
                                                    <i class="bi bi-person"></i> {{ item.owner }}
                                                </span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-success"
                                                onclick="openGenModal(this)"
                                                data-task-id="{{ item.id }}"
                                                data-contract="{{ item.contract_name }}"
                                                data-theme="{{ item.theme_name }}"
                                                data-frequency="{{ item.frequency }}"
                                                data-owner="{{ item.owner }}">
                                            ç”Ÿæˆ
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-center py-4 text-muted">æœªæ‰¾åˆ°åŒ¹é…é¡¹</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">è¯·å…ˆæœç´¢å…³é”®è¯ä»¥ç”Ÿæˆæ–°ä»»åŠ¡</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-view" role="tabpanel">
            <div class="card border-top-0 rounded-0 shadow-sm">
                <div class="card-body">

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-3">
                            <div class="alert alert-primary py-1 px-3 m-0 d-flex align-items-center">
                                <i class="bi bi-activity me-2"></i>
                                <div>è¿›è¡Œä¸­ï¼š<strong class="fs-5">{{ ongoing_count }}</strong></div>
                            </div>
                            <div class="ms-auto">
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="batchDeleteTasks()">
                                    <i class="bi bi-trash"></i> æ‰¹é‡åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-light border-0 mb-3">
                        <div class="card-body py-2">
                            <form method="GET" action="{{ url_for('task_management') }}" class="row g-2 align-items-center">
                                <div class="col-md-3">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white">åˆåŒ</span>
                                        <input type="text" name="view_contract" class="form-control"
                                               placeholder="æ”¯æŒæ¨¡ç³Šæœç´¢" value="{{ view_contract }}">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white">ä¸»é¢˜</span>
                                        <input type="text" name="view_theme" class="form-control"
                                               placeholder="æ”¯æŒæ¨¡ç³Šæœç´¢" value="{{ view_theme }}">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white">äººå‘˜</span>
                                        <select name="view_owner" class="form-select">
                                            <option value="">å…¨éƒ¨</option>
                                            {% for owner in all_owners %}
                                                <option value="{{ owner }}" {% if view_owner == owner %}selected{% endif %}>
                                                    {{ owner }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white">çŠ¶æ€</span>
                                        <select name="view_status" class="form-select">
                                            <option value="all" {% if view_status == 'all' %}selected{% endif %}>å…¨éƒ¨</option>
                                            <option value="pending" {% if view_status == 'pending' %}selected{% endif %}>ğŸŸ¡ è¿›è¡Œä¸­</option>
                                            <option value="completed" {% if view_status == 'completed' %}selected{% endif %}>ğŸŸ¢ å·²å®Œæˆ</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2 text-end">
                                    <div class="btn-group w-100">
                                        <button type="submit" class="btn btn-sm btn-primary">
                                            <i class="bi bi-funnel"></i> ç­›é€‰
                                        </button>
                                        <a href="{{ url_for('task_management') }}" class="btn btn-sm btn-outline-secondary" title="é‡ç½®">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px;" class="text-center">
                                        <input type="checkbox" class="form-check-input" id="checkAllView" onchange="toggleAllView(this)">
                                    </th>
                                    <th class="text-center" style="width: 60px;">åºå·</th>
                                    <th style="width: 100px;" class="text-center">çŠ¶æ€</th>
                                    <th>ä»»åŠ¡ä¿¡æ¯ (åˆåŒ/ä¸»é¢˜)</th>
                                    <th>è´Ÿè´£äºº</th>
                                    <th>å½’å±/æˆªæ­¢/å®Œæˆ</th>
                                    <th class="text-center">æ•°æ®é‡</th>
                                    <th style="width: 160px;" class="text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in all_instances %}
                                <tr class="{{ 'table-success' if task.status == 'completed' else '' }}">
                                    <td class="text-center">
                                        <input type="checkbox" class="form-check-input task-view-check" value="{{ task.id }}">
                                    </td>
                                    <td class="text-center text-muted fw-bold">{{ loop.index }}</td>
                                    <td class="text-center">
                                        {% if task.status == 'completed' %}
                                            <span class="badge bg-success">å·²å®Œæˆ</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">è¿›è¡Œä¸­</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="fw-bold small">{{ task.contract_name }}</div>
                                        <div class="text-primary small">{{ task.theme_name }}</div>
                                    </td>
                                    <td>{{ task.owner }}</td>
                                    <td>
                                        <div class="small">å±ï¼š{{ task.belong_month }}</div>
                                        <div class="small {{ 'text-danger fw-bold' if task.status!='completed' and task.deadline < today else '' }}">
                                            æ­¢ï¼š{{ task.deadline }}
                                        </div>
                                        {% if task.status == 'completed' and task.finished_at %}
                                            <div class="small text-success fw-bold">
                                                å®Œï¼š{{ task.finished_at }}
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td class="text-center fw-bold">{{ task.data_count }}</td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal(this)"
                                                    data-id="{{ task.id }}"
                                                    data-deadline="{{ task.deadline }}"
                                                    data-status="{{ task.status }}"
                                                    data-count="{{ task.data_count }}"
                                                    data-finished-at="{{ task.finished_at or '' }}"
                                                    data-owner="{{ task.owner }}"
                                                    data-contract="{{ task.contract_name }}"
                                                    data-theme="{{ task.theme_name }}"
                                                    data-service="{{ task.task.service_content if task.task else 'ï¼ˆæœåŠ¡å†…å®¹å·²å½’æ¡£æˆ–åˆ é™¤ï¼‰' }}">
                                                <i class="bi bi-pencil-square"></i> ç¼–è¾‘
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTaskInstance({{ task.id }})">
                                                <i class="bi bi-trash"></i> åˆ é™¤
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="8" class="text-center py-5 text-muted">æš‚æ— ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡è®°å½•</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-stat" role="tabpanel">
            <div class="card border-top-0 rounded-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0"><i class="bi bi-table text-primary"></i> æ¯æ—¥æ•°æ®é‡é€è§†è¡¨</h5>
                        <form class="d-flex align-items-center" method="GET" action="{{ url_for('task_management') }}">
                            <input type="hidden" name="active_tab" value="stat">
                            <label class="me-2 fw-bold text-secondary">ç»Ÿè®¡æœˆä»½:</label>
                            <input type="month" name="month" class="form-control form-control-sm me-2"
                                   value="{{ stat_month }}" style="width: 150px;">
                            <button type="submit" class="btn btn-sm btn-primary">
                                <i class="bi bi-funnel"></i> ç»Ÿè®¡
                            </button>
                        </form>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center align-middle table-hover" style="font-size: 0.9rem;">
                            <thead class="table-light">
                                <tr>
                                    <th style="min-width: 140px; background-color: #f8f9fa;">
                                        <div class="d-flex justify-content-between">
                                            <span class="small text-muted" style="margin-top: 10px;">å®Œæˆæ—¶é—´</span>
                                            <span class="small text-muted" style="margin-bottom: 10px;">è´Ÿè´£äºº</span>
                                        </div>
                                    </th>
                                    {% for owner in all_owners %}
                                    <th class="py-2">{{ owner }}</th>
                                    {% endfor %}
                                    <th class="bg-light fw-bold text-dark">åˆè®¡</th>
                                </tr>
                            </thead>
                            <thead class="table-group-divider" style="border-top: 2px solid #aaa;">
                                <tr class="table-light fw-bold" style="font-size: 1rem;">
                                    <td class="text-end pe-3 text-center">æœˆåº¦æ€»è®¡</td>
                                    {% for owner in all_owners %}
                                    <td class="text-primary">{{ col_totals[owner] }}</td>
                                    {% endfor %}
                                    <td class="text-white bg-secondary">{{ grand_total }}</td>
                                </tr>
                            </thead>
                            <tbody>
                                {% for date in date_list %}
                                <tr>
                                    <td class="fw-bold text-secondary bg-light">{{ date }}</td>
                                    {% for owner in all_owners %}
                                        {% set val = stats_matrix[date][owner] %}
                                        <td>
                                            {% if val > 0 %}
                                                <span class="text-dark fw-medium">{{ val }}</span>
                                            {% else %}
                                                <span class="text-muted small" style="color: #e0e0e0 !important;">-</span>
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                    <td class="fw-bold bg-light">
                                        {% if row_totals[date] > 0 %}
                                            {{ row_totals[date] }}
                                        {% else %} - {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="{{ all_owners|length + 2 }}" class="text-center py-5 text-muted">è¯¥æœˆæ— å®Œæˆæ•°æ®</td></tr>
                                {% endfor %}
                            </tbody>

                        </table>
                    </div>
                    <div class="mt-2 small text-muted">
                        <i class="bi bi-info-circle"></i> è¯´æ˜ï¼šæ•°æ®åŸºäºâ€œä»»åŠ¡å®Œæˆæ—¶é—´â€è¿›è¡Œå½’é›†ï¼›ä»…ç»Ÿè®¡çŠ¶æ€ä¸ºâ€œå·²å®Œæˆâ€çš„æ•°æ®é‡ã€‚
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="genModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">ç”Ÿæˆä»»åŠ¡</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="gen_task_id">
                <p><strong>åˆåŒï¼š</strong><span id="gen_contract"></span></p>
                <p><strong>ä¸»é¢˜ï¼š</strong><span id="gen_theme"></span></p>
                <p><strong>è´Ÿè´£äººï¼š</strong><span id="gen_owner" class="text-primary fw-bold"></span></p>
                <p><strong>é¢‘ç‡ï¼š</strong><span id="gen_freq"></span></p>
                <hr>
                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label small">æ‰€å±å¹´æœˆ</label>
                        <input type="month" id="gen_month" class="form-control">
                    </div>
                    <div class="col-6">
                        <label class="form-label small">æˆªæ­¢æ—¶é—´</label>
                        <input type="date" id="gen_deadline" class="form-control">
                        <div class="form-text small text-end text-success" id="deadline_tip"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success w-100" onclick="submitGen()">ç¡®è®¤ç”Ÿæˆ</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="batchGenModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-collection-play"></i> æ‰¹é‡ç”Ÿæˆä»»åŠ¡</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2">
                    å·²é€‰æ‹© <strong id="batch_count" class="fs-5">0</strong> ä¸ªä»»åŠ¡é¡¹
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">æ‰€å±å¹´æœˆ <span class="text-danger">*</span></label>
                    <input type="month" id="batch_month" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">æˆªæ­¢æ—¶é—´è§„åˆ™</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deadlineRadio" id="radioAuto" value="auto" checked>
                        <label class="form-check-label" for="radioAuto">æ™ºèƒ½è®¡ç®— (æ ¹æ®é¢‘ç‡)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deadlineRadio" id="radioManual" value="manual">
                        <label class="form-check-label" for="radioManual">ç»Ÿä¸€æŒ‡å®šæ—¥æœŸ</label>
                    </div>
                    <div id="batch_deadline_box" class="mt-2 ms-4" style="display:none;">
                        <input type="date" id="batch_deadline_manual" class="form-control form-control-sm">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="submitBatchGen()">ç¡®è®¤æ‰¹é‡ç”Ÿæˆ</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">ç¼–è¾‘ä»»åŠ¡</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_id">
                <div class="bg-light p-3 rounded mb-3 border">
                    <div class="mb-2">
                        <small class="text-muted d-block">åˆåŒä¿¡æ¯</small>
                        <div class="text-dark" id="display_contract"></div>
                        <div class="text-secondary" id="display_service"></div>
                        <div class="text-primary" id="display_theme"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">ä»»åŠ¡è´Ÿè´£äºº</label>
                    <select id="edit_owner" class="form-select">
                        {% for owner in all_owners %}
                            <option value="{{ owner }}">{{ owner }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">ä»»åŠ¡æ•°æ®é‡</label>
                    <input type="number" id="edit_count" class="form-control" placeholder="è¯·è¾“å…¥æ¡æ•°">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">ä»»åŠ¡çŠ¶æ€</label>
                    <select id="edit_status" class="form-select" onchange="autoFillFinishTime()">
                        <option value="pending">ğŸŸ¡ è¿›è¡Œä¸­ </option>
                        <option value="completed">ğŸŸ¢ å·²å®Œæˆ </option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold text-success">å®Œæˆæ—¶é—´</label>
                    <input type="date" id="edit_finished_at" class="form-control border-success">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">æˆªæ­¢æ—¶é—´å˜æ›´</label>
                    <input type="date" id="edit_deadline" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitEdit()">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- é¡µé¢åŠ è½½ï¼šä¿æŒ Tab çŠ¶æ€ ---
    document.addEventListener("DOMContentLoaded", function(){
        const urlParams = new URLSearchParams(window.location.search);
        // å¦‚æœæœ‰ view_* å‚æ•°ï¼Œä¹Ÿé»˜è®¤åœç•™åœ¨ æŸ¥çœ‹Tab
        if(urlParams.has('month')) {
            new bootstrap.Tab(document.querySelector('#tab-stat-btn')).show();
        } else if(urlParams.has('q')) {
            new bootstrap.Tab(document.querySelector('#tab-gen-btn')).show();
        } else {
             new bootstrap.Tab(document.querySelector('#tab-view-btn')).show();
        }

        // ç›‘å¬æ‰¹é‡ç”Ÿæˆå¼¹çª—çš„å•é€‰æ¡† (é˜²æ­¢å…ƒç´ ä¸å­˜åœ¨æŠ¥é”™)
        const radios = document.getElementsByName('deadlineRadio');
        if(radios.length > 0) {
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const box = document.getElementById('batch_deadline_box');
                    if(box) box.style.display = (this.value === 'manual') ? 'block' : 'none';
                });
            });
        }
    });

    // ================== 1. å•ä¸ªç”Ÿæˆé€»è¾‘ ==================
    function openGenModal(btn) {
        document.getElementById('gen_task_id').value = btn.dataset.taskId;
        document.getElementById('gen_contract').innerText = btn.dataset.contract;
        document.getElementById('gen_theme').innerText = btn.dataset.theme;
        document.getElementById('gen_owner').innerText = btn.dataset.owner || 'æœªæŒ‡å®š';
        document.getElementById('gen_freq').innerText = btn.dataset.frequency || 'æœªé…ç½®';

        // è‡ªåŠ¨è®¡ç®—æ—¶é—´
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        document.getElementById('gen_month').value = `${y}-${m}`;

        const freq = btn.dataset.frequency || '';
        const deadlineDate = calculateDeadline(now, freq);
        document.getElementById('gen_deadline').value = formatDate(deadlineDate);
        document.getElementById('deadline_tip').innerText = `å·²æ ¹æ® [${freq}] è‡ªåŠ¨æ¨ç®—`;

        new bootstrap.Modal(document.getElementById('genModal')).show();
    }

    // æ—¥æœŸè®¡ç®—å·¥å…·
    function calculateDeadline(baseDate, freq) {
        let target = new Date(baseDate);
        if (!freq) freq = "";
        if (freq.includes("æœˆ")) target.setMonth(target.getMonth() + 1);
        else if (freq.includes("å‘¨")) target.setDate(target.getDate() + 7);
        else if (freq.includes("å­£")) target.setMonth(target.getMonth() + 3);
        else if (freq.includes("å¹´")) target.setFullYear(target.getFullYear() + 1);
        else if (freq.includes("æ—¥")) target.setDate(target.getDate() + 1);
        else target.setDate(target.getDate() + 3);
        return target;
    }

    function formatDate(date) {
        const y = date.getFullYear();
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const d = date.getDate().toString().padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function submitGen() {
        const data = {
            task_id: document.getElementById('gen_task_id').value,
            contract_name: document.getElementById('gen_contract').innerText,
            theme_name: document.getElementById('gen_theme').innerText,
            owner: document.getElementById('gen_owner').innerText,
            belong_month: document.getElementById('gen_month').value,
            deadline: document.getElementById('gen_deadline').value
        };
        fetch('/api/generate_task', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        }).then(r => r.json()).then(res => {
            alert(res.message); location.reload();
        });
    }

    // ================== 2. æ‰¹é‡ç”Ÿæˆé€»è¾‘ ==================
    function toggleAll(source) {
        document.querySelectorAll('.task-check').forEach(cb => cb.checked = source.checked);
    }

    function openBatchModal() {
        const selected = document.querySelectorAll('.task-check:checked');
        if (selected.length === 0) { alert("è¯·è‡³å°‘å‹¾é€‰ä¸€ä¸ªä»»åŠ¡ï¼"); return; }

        document.getElementById('batch_count').innerText = selected.length;

        const now = new Date();
        document.getElementById('batch_month').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        document.getElementById('radioAuto').checked = true;
        const box = document.getElementById('batch_deadline_box');
        if(box) box.style.display = 'none';

        new bootstrap.Modal(document.getElementById('batchGenModal')).show();
    }

    function submitBatchGen() {
        const month = document.getElementById('batch_month').value;
        if (!month) { alert("è¯·é€‰æ‹©æ‰€å±å¹´æœˆï¼"); return; }

        const mode = document.querySelector('input[name="deadlineRadio"]:checked').value;
        const manualDate = document.getElementById('batch_deadline_manual').value;
        if (mode === 'manual' && !manualDate) { alert("è¯·é€‰æ‹©ç»Ÿä¸€æˆªæ­¢æ—¥æœŸï¼"); return; }

        const tasksPayload = [];
        const now = new Date();
        document.querySelectorAll('.task-check:checked').forEach(cb => {
            const freq = cb.dataset.frequency || '';
            let d = (mode === 'manual') ? manualDate : formatDate(calculateDeadline(now, freq));
            tasksPayload.push({
                task_id: cb.value,
                contract_name: cb.dataset.contract,
                theme_name: cb.dataset.theme,
                owner: cb.dataset.owner,
                belong_month: month,
                deadline: d
            });
        });

        fetch('/api/batch_generate_tasks', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ tasks: tasksPayload })
        }).then(r => r.json()).then(res => {
            alert(res.message); location.reload();
        });
    }

    // ================== 3. ç¼–è¾‘ä»»åŠ¡é€»è¾‘ ==================
    function openEditModal(btn) {
        document.getElementById('edit_id').value = btn.dataset.id;
        document.getElementById('edit_deadline').value = btn.dataset.deadline;
        document.getElementById('edit_status').value = btn.dataset.status;
        document.getElementById('edit_count').value = btn.dataset.count;
        document.getElementById('edit_finished_at').value = btn.dataset.finishedAt;
        document.getElementById('edit_owner').value = btn.dataset.owner;
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    function autoFillFinishTime() {
        const status = document.getElementById('edit_status').value;
        const timeInput = document.getElementById('edit_finished_at');
        if (status === 'completed' && !timeInput.value) {
            const now = new Date();
            timeInput.value = formatDate(now);
        }
    }

    function submitEdit() {
        const data = {
            id: document.getElementById('edit_id').value,
            deadline: document.getElementById('edit_deadline').value,
            status: document.getElementById('edit_status').value,
            data_count: document.getElementById('edit_count').value,
            finished_at: document.getElementById('edit_finished_at').value,
            owner: document.getElementById('edit_owner').value
        };
        fetch('/api/update_task_instance', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        }).then(r => r.json()).then(res => {
            alert(res.message); location.reload();
        });
    }

    // ================== 4. æ‰¹é‡åˆ é™¤é€»è¾‘ ==================
    function toggleAllView(source) {
        document.querySelectorAll('.task-view-check').forEach(cb => cb.checked = source.checked);
    }

    function deleteTaskInstance(id) {
        if (!confirm('âš ï¸ ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ï¼Ÿ')) return;
        fetch('/api/delete_task_instance/' + id, { method: 'POST' })
            .then(r => r.json()).then(res => {
                if(res.status==='success') location.reload(); else alert(res.message);
            });
    }

    function batchDeleteTasks() {
        const selected = document.querySelectorAll('.task-view-check:checked');
        if (selected.length === 0) { alert("è¯·å…ˆå‹¾é€‰ä»»åŠ¡ï¼"); return; }
        const ids = Array.from(selected).map(cb => cb.value);
        if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤è¿™ ${ids.length} æ¡ä»»åŠ¡å—ï¼Ÿ`)) return;

        fetch('/api/batch_delete_task_instances', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ids: ids })
        }).then(r => r.json()).then(res => {
            alert(res.message); location.reload();
        });
    }
    function openEditModal(btn) {
        // 1. å¡«å……è¡¨å•æ•°æ® (å¯ç¼–è¾‘)
        document.getElementById('edit_id').value = btn.dataset.id;
        document.getElementById('edit_deadline').value = btn.dataset.deadline;
        document.getElementById('edit_status').value = btn.dataset.status;
        document.getElementById('edit_count').value = btn.dataset.count;
        document.getElementById('edit_finished_at').value = btn.dataset.finishedAt;
        document.getElementById('edit_owner').value = btn.dataset.owner;

        // 2. âœ¨ å¡«å……åŸºç¡€ä¿¡æ¯ (åªè¯»å±•ç¤º)
        document.getElementById('display_contract').innerText = btn.dataset.contract;
        document.getElementById('display_service').innerText = btn.dataset.service;
        document.getElementById('display_theme').innerText = btn.dataset.theme;

        new bootstrap.Modal(document.getElementById('editModal')).show();
    }
</script>
{% endblock %}