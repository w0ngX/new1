{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">ä¸»é¢˜ç®¡ç† <small class="text-muted fs-6">(å…± {{ pagination.total }} æ¡)</small></h3>
    <div>
        <button type="button" class="btn btn-danger btn-sm me-1" id="btnBatchDelete" onclick="submitBatchDelete()" disabled>
            <i class="bi bi-trash"></i> æ‰¹é‡åˆ é™¤ <span id="selectCountText"></span>
        </button>
        <button type="button" class="btn btn-outline-success btn-sm me-1" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="bi bi-file-earmark-excel"></i> æ‰¹é‡å¯¼å…¥ä¸»é¢˜
        </button>
        <a href="{{ url_for('edit_topic', id=0) }}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-lg"></i> æ–°å¢ä¸»é¢˜
        </a>
    </div>
</div>

<div class="card bg-light mb-3">
    <div class="card-body py-2">
        <form action="{{ url_for('topics') }}" method="get" class="row g-2 align-items-center">
            <!-- ä¸€çº§ä¸»é¢˜ä¸‹æ‹‰æ¡† -->
            <div class="col-auto">
                <select name="parent" id="level1_select" class="form-select form-select-sm" onchange="handleTopicChange('level1')">
                    <option value="">-- æ‰€æœ‰ä¸€çº§ä¸»é¢˜ --</option>
                    {% for p in all_parents %}
                    <option value="{{ p }}" {% if request.args.get('parent') == p %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- äºŒçº§ä¸»é¢˜ä¸‹æ‹‰æ¡† -->
            <div class="col-auto">
                <select name="level2" id="level2_select" class="form-select form-select-sm" onchange="handleTopicChange('level2')">
                    <option value="">-- æ‰€æœ‰äºŒçº§ä¸»é¢˜ --</option>
                    {% for l2 in all_level2_list %}
                    <option value="{{ l2 }}" {% if request.args.get('level2') == l2 %}selected{% endif %}>{{ l2 }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- ä¸»é¢˜åç§°ä¸‹æ‹‰æ¡† -->
            <div class="col-auto">
                <select name="name" id="topic_name_select" class="form-select form-select-sm" onchange="handleTopicChange('name')">
                    <option value="">-- æ‰€æœ‰ä¸»é¢˜åç§° --</option>
                    {% for t_name in all_topic_names %}
                    <option value="{{ t_name }}" {% if request.args.get('name') == t_name %}selected{% endif %}>{{ t_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-auto">
                <select name="owner" class="form-select form-select-sm">
                    <option value="">-- æ‰€æœ‰è´Ÿè´£äºº --</option>
                    {% for owner in all_owners %}
                        <option value="{{ owner }}" {% if request.args.get('owner') == owner %}selected{% endif %}>
                            {{ owner }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-secondary">ğŸ” æœç´¢</button>
                <a href="{{ url_for('topics') }}" class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">é‡ç½®</a>
            </div>
        </form>
    </div>
</div>

<form id="batchForm" action="{{ url_for('batch_delete_topics') }}" method="post">
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width: 40px;" class="text-center"><input type="checkbox" class="form-check-input" id="selectAll"></th>
                    <th>åºå·</th>
                    <th>ä¸€çº§ä¸»é¢˜</th>
                    <th>äºŒçº§ä¸»é¢˜</th>
                    <th>ä¸»é¢˜åç§°</th>
                    <th>é‡‡é›†æ–¹å¼</th>
                    <th>é‡‡é›†é¢‘ç‡</th>
                    <th>è´Ÿè´£äºº</th>
                    <th style="width: 150px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for t in pagination.items %}
                <tr>
                    <td class="text-center"><input type="checkbox" class="form-check-input item-checkbox" name="selected_ids" value="{{ t.id }}"></td>
                    <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                    <td>{{ t.level1_id }}</td>
                    <td>{{ t.level2_id }}</td>
                    <td>
                        {{ t.name }}<i class="small text-muted"> {{ t.theme_id }}</i>
                    </td>

                    <td>
                    {% if t.method %}
                        {% for m in t.method.split(',') %}
                            {% if m == 'ç¨‹åºé‡‡é›†' %}
                                <span class=" text-primary ">{{ m }}</span>
                            {% elif m == 'äººå·¥é‡‡é›†' %}
                                <span class=" text-success ">{{ m }}</span>
                            {% else %}
                                <span class=" text-primary ">{{ m }}</span>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <span class="text-muted small">-</span>
                    {% endif %}
                    </td>
                    <td>
                      {% if t.frequency %}
                          <span class=" text-dark ">{{ t.frequency }}</span>
                      {% else %}
                          <span class="text-muted small">-</span>
                      {% endif %}
                    </td>
                    <td>
                        {% if t.owner and t.owner.strip() %}
                            {{ t.owner }}
                        {% else %}
                         <!-- (æœªæŒ‡å®šè´Ÿè´£äºº) -->
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('edit_topic', id=t.id) }}" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a>
                            <a href="{{ url_for('delete_topic', id=t.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ');">åˆ é™¤</a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="10" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>

<nav aria-label="Page navigation" class="mt-4">
    <div class="d-flex justify-content-center align-items-center flex-wrap gap-3">
        <ul class="pagination mb-0">
            {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('topics', page=pagination.prev_num, name=request.args.get('name', ''), owner=request.args.get('owner', ''), parent=request.args.get('parent', ''), level2_id=request.args.get('level2_id', ''),level2_select=s_level2_select,owner_select=s_owner_select)}}">
                        <i class="bi bi-chevron-left"></i> ä¸Šä¸€é¡µ
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link"><i class="bi bi-chevron-left"></i> ä¸Šä¸€é¡µ</span></li>
            {% endif %}

            <li class="page-item active">
                <span class="page-link">ç¬¬ {{ pagination.page }} é¡µ / å…± {{ pagination.pages }} é¡µ</span>
            </li>

            {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('topics', page=pagination.next_num, name=request.args.get('name', ''), owner=request.args.get('owner', ''), parent=request.args.get('parent', ''), level2_id=request.args.get('level2_id', ''),level2_select=s_level2_select,owner_select=s_owner_select) }}">
                        ä¸‹ä¸€é¡µ <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">ä¸‹ä¸€é¡µ <i class="bi bi-chevron-right"></i></span></li>
            {% endif %}
        </ul>

        <div class="d-flex align-items-center">
            <span class="me-2 text-muted small">è·³è½¬è‡³</span>
            <input type="number" id="jumpPageInput" class="form-control form-control-sm text-center" style="width: 60px;" min="1" max="{{ pagination.pages }}" value="{{ pagination.page }}">
            <span class="ms-2 me-2 text-muted small">é¡µ</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="jumpToPage()">ç¡®å®š</button>
        </div>
    </div>
</nav>
<!---å¯¼å…¥ä¸»é¢˜æ¨¡æ€æ¡†--->
<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-file-earmark-excel-fill me-2"></i>æ‰¹é‡å¯¼å…¥ä¸»é¢˜</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form action="{{ url_for('import_topic_excel') }}" method="post" enctype="multipart/form-data">
                <div class="modal-body p-4">
                    <div class="row g-4">

                        <div class="col-lg-5">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="fw-bold text-success mb-3">
                                        <i class="bi bi-list-check me-1"></i> ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æ•°æ®è§„èŒƒ
                                    </h6>
                                    <ul class="list-group list-group-flush bg-transparent small">
                                        <li class="list-group-item bg-transparent px-0">
                                            <span class="badge bg-danger me-2">å¿…å¡«</span>
                                            <strong>ä¸€çº§ä¸»é¢˜ã€äºŒçº§ä¸»é¢˜ã€ä¸»é¢˜IDã€ä¸»é¢˜åç§°ã€è´Ÿè´£äºº</strong>
                                        </li>
                                        <li class="list-group-item bg-transparent px-0">
                                            <span class="badge bg-secondary me-2">é€‰å¡«</span>
                                            é‡‡é›†é¢‘ç‡ã€é‡‡é›†æ–¹å¼
                                        </li>
                                        <li class="list-group-item bg-transparent px-0">
                                            <i class="bi bi-info-circle-fill text-primary me-1"></i>
                                            <strong>è´Ÿè´£äººï¼š</strong>è‹¥ä¸ºç©ºï¼Œç³»ç»Ÿè‡ªåŠ¨å¡«å……ä¸ºâ€œ(æœªæŒ‡å®šè´Ÿè´£äºº)â€
                                        </li>
                                        <li class="list-group-item bg-transparent px-0">
                                            <i class="bi bi-info-circle-fill text-primary me-1"></i>
                                            <strong>é‡‡é›†æ–¹å¼ï¼š</strong>éœ€åŒ…å«â€œç¨‹åºâ€æˆ–â€œäººå·¥â€å…³é”®è¯
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-7">
                            <div class="border rounded p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold text-primary m-0">
                                        <i class="bi bi-table me-1"></i> æ¨¡æ¿æ ¼å¼é¢„è§ˆ
                                    </h6>
                                    <a href="{{ url_for('download_topic_template') }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-download me-1"></i> ä¸‹è½½æ ‡å‡† Excel æ¨¡æ¿
                                    </a>
                                </div>

                                <div class="table-responsive border rounded bg-white" style="font-size: 12px;">
                                    <table class="table table-bordered table-sm mb-0 text-center text-nowrap">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="text-danger">ä¸€çº§ä¸»é¢˜*</th>
                                                <th class="text-danger">äºŒçº§ä¸»é¢˜*</th>
                                                <th class="text-danger">ä¸»é¢˜ID*</th>
                                                <th class="text-danger">ä¸»é¢˜åç§°*</th>
                                                <th>é‡‡é›†æ–¹å¼</th>
                                                <th>é‡‡é›†é¢‘ç‡</th>
                                                <th class="text-danger">è´Ÿè´£äºº*</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>ç¤¾ä¼šå»ºè®¾</td>
                                                <td>æ•™è‚²æ–‡åŒ–</td>
                                                <td>A001</td>
                                                <td>ç§‘ç ”æ•°æ®</td>
                                                <td>ç¨‹åºé‡‡é›†</td>
                                                <td>æœˆ</td>
                                                <td>å¼ ä¸‰</td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">...</td>
                                                <td class="text-muted">...</td>
                                                <td class="text-muted">...</td>
                                                <td class="text-muted">...</td>
                                                <td class="text-muted">...</td>
                                                <td class="text-muted">...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="form-text mt-2 text-muted">
                                    <small>* çº¢è‰²æ ‡é¢˜ä¸ºå¿…é¡»å­˜åœ¨çš„åˆ—åï¼Œè¯·å‹¿ä¿®æ”¹æ¨¡æ¿è¡¨å¤´ã€‚</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="row justify-content-center">
                        <div class="col-lg-8 text-center">
                            <h6 class="fw-bold mb-3">ç¬¬äºŒæ­¥ï¼šä¸Šä¼ å¡«å†™å¥½çš„æ–‡ä»¶</h6>
                            <div class="input-group input-group-lg">
                                <input type="file" class="form-control" name="file" accept=".xlsx, .xls" required>
                                <button type="submit" class="btn btn-success ">
                                    <i class="bi bi-cloud-upload-fill me-1"></i> ç¡®è®¤å¯¼å…¥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    // --- åˆ†é¡µè·³è½¬ ---
    function jumpToPage() {
        const pageNum = document.getElementById('jumpPageInput').value;
        const maxPage = {{ pagination.pages }};
        if (pageNum >= 1 && pageNum <= maxPage) {
            const url = new URL(window.location.href);
            url.searchParams.set('page', pageNum);
            window.location.href = url.pathname + url.search;
        } else { alert(`è¯·è¾“å…¥ 1 åˆ° ${maxPage} ä¹‹é—´çš„é¡µç `); }
    }
    document.getElementById('jumpPageInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') jumpToPage();
    });

    // --- æ‰¹é‡åˆ é™¤é€»è¾‘ ---
    function submitBatchDelete() {
        var len = document.querySelectorAll('.item-checkbox:checked').length;
        if (len === 0) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹ï¼'); return; }
        if (confirm('ç¡®å®šè¦æ‰¹é‡åˆ é™¤é€‰ä¸­çš„ ' + len + ' é¡¹å—ï¼Ÿ')) {
            document.getElementById('batchForm').submit();
        }
    }

    // --- å…¨é€‰ä¸æŒ‰é’®è”åŠ¨ ---
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        const btnBatchDelete = document.getElementById('btnBatchDelete');
        const selectCountText = document.getElementById('selectCountText');

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateBatchButton() {
            const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
            if (checkedCount > 0) {
                btnBatchDelete.disabled = false;
                selectCountText.innerText = '(' + checkedCount + ')';
            } else {
                btnBatchDelete.disabled = true;
                selectCountText.innerText = '';
            }
        }

        // å…¨é€‰äº‹ä»¶
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                itemCheckboxes.forEach(cb => cb.checked = isChecked);
                updateBatchButton();
            });
        }

        // å•é€‰äº‹ä»¶
        itemCheckboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                updateBatchButton();
                if (!this.checked && selectAllCheckbox) selectAllCheckbox.checked = false;
            });
        });

        // --- é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡è”åŠ¨ç­›é€‰ ---
        initTopicFilters();
    });

    // --- ä¸‰çº§è”åŠ¨ç­›é€‰é€»è¾‘ ---

    // å…³é”®ä¿®å¤ 1: ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®å˜é‡åï¼Œé¿å…é‡å¤
    const topicRelationsData = {{ topic_relations | tojson }};

    // å…³é”®ä¿®å¤ 2: å¤‡ä»½åŸå§‹é€‰é¡¹
    let originalOptions = {
        level1: [],
        level2: [],
        names: []
    };

    // å…³é”®ä¿®å¤ 3: åˆå§‹åŒ–å‡½æ•°ï¼Œåªå®šä¹‰ä¸€æ¬¡
    function initTopicFilters() {
        // å¤‡ä»½åŸå§‹é€‰é¡¹
        document.querySelectorAll('#level1_select option').forEach(opt => {
            if (opt.value) originalOptions.level1.push({value: opt.value, text: opt.text});
        });
        document.querySelectorAll('#level2_select option').forEach(opt => {
            if (opt.value) originalOptions.level2.push({value: opt.value, text: opt.text});
        });
        document.querySelectorAll('#topic_name_select option').forEach(opt => {
            if (opt.value) originalOptions.names.push({value: opt.value, text: opt.text});
        });

        // æ ¹æ®URLä¸­çš„å‚æ•°åˆå§‹åŒ–ç­›é€‰
        const currentLevel1 = document.getElementById('level1_select').value;
        const currentLevel2 = document.getElementById('level2_select').value;
        const currentName = document.getElementById('topic_name_select').value;

        // å¦‚æœä¸€çº§ä¸»é¢˜æœ‰å€¼ï¼Œè§¦å‘ä¸€çº§ä¸»é¢˜å˜åŒ–
        if (currentLevel1) {
            handleTopicChange('level1');
        }
        // å¦åˆ™å¦‚æœäºŒçº§ä¸»é¢˜æœ‰å€¼ï¼Œè§¦å‘äºŒçº§ä¸»é¢˜å˜åŒ–
        else if (currentLevel2) {
            handleTopicChange('level2');
        }
        // å¦åˆ™å¦‚æœä¸»é¢˜åç§°æœ‰å€¼ï¼Œè§¦å‘ä¸»é¢˜åç§°å˜åŒ–
        else if (currentName) {
            handleTopicChange('name');
        }
    }

    // å…³é”®ä¿®å¤ 4: æ ¸å¿ƒè”åŠ¨å‡½æ•°ï¼Œå¤„ç†ä¸‰çº§è”åŠ¨
    function handleTopicChange(source) {
        const el1 = document.getElementById('level1_select');
        const el2 = document.getElementById('level2_select');
        const elN = document.getElementById('topic_name_select');

        // è·å–å½“å‰å„ä¸‹æ‹‰æ¡†çš„å€¼
        const val1 = el1.value;
        const val2 = el2.value;
        const valN = elN.value;

        // å®šä¹‰è¿‡æ»¤åçš„æ•°æ®é›†ï¼Œåˆå§‹ä¸ºå…¨éƒ¨æ•°æ®
        let filtered = topicRelationsData;

        // æ ¸å¿ƒç­–ç•¥ï¼šä»¥"æœ€åæ“ä½œ"çš„é‚£ä¸ªä¸‹æ‹‰æ¡†ä¸ºåŸºå‡†è¿›è¡Œè¿‡æ»¤
        // å¦‚æœé€‰äº†"å…¨éƒ¨/ç©º"ï¼Œåˆ™é‡ç½®ä¸ºå…¨éƒ¨æ•°æ®
        if (source === 'level1' && val1) {
            filtered = topicRelationsData.filter(item => item.p === val1);
        } else if (source === 'level2' && val2) {
            filtered = topicRelationsData.filter(item => item.l2 === val2);
        } else if (source === 'name' && valN) {
            filtered = topicRelationsData.filter(item => item.n === valN);
        }

        // è®¡ç®—å‡ºå„åˆ—æ–°çš„æœ‰æ•ˆé€‰é¡¹åˆ—è¡¨ (å»é‡ + æ’åº)
        const validL1 = [...new Set(filtered.map(item => item.p))].sort();
        const validL2 = [...new Set(filtered.map(item => item.l2))].sort();
        const validN  = [...new Set(filtered.map(item => item.n))].sort();

        // æ›´æ–°ä¸‹æ‹‰æ¡†é€‰é¡¹
        // æ³¨æ„ï¼šä¸è¦æ›´æ–°"è§¦å‘è€…"è‡ªå·±ï¼Œå¦åˆ™ç”¨æˆ·åˆšé€‰çš„å€¼ä¼šè¢«åˆ·æ‰
        if (source !== 'level1') updateSelect(el1, validL1, val1);
        if (source !== 'level2') updateSelect(el2, validL2, val2);
        if (source !== 'name')   updateSelect(elN, validN, valN);

        // ç‰¹æ®Šä¼˜åŒ–ï¼šå¦‚æœæ˜¯éè§¦å‘è€…ï¼Œä¸”è¿‡æ»¤ååªå‰©å”¯ä¸€çš„é€‰é¡¹ï¼Œè‡ªåŠ¨é€‰ä¸­å®ƒ
        if (source !== 'level1' && validL1.length === 1) el1.value = validL1[0];
        if (source !== 'level2' && validL2.length === 1) el2.value = validL2[0];
        if (source !== 'name'   && validN.length === 1)  elN.value = validN[0];
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°ä¸‹æ‹‰æ¡†çš„ <option>
    function updateSelect(selectEl, validItems, currentValue) {
        // ä¿ç•™ç¬¬ä¸€é¡¹ "-- æ‰€æœ‰ --"
        const placeholder = selectEl.options[0].text;

        // é‡å»º HTML
        let html = `<option value="">${placeholder}</option>`;
        validItems.forEach(item => {
            if (item) { // è¿‡æ»¤æ‰ null/undefined
                // å¦‚æœè¯¥é¡¹æ­£å¥½æ˜¯ä¹‹å‰é€‰ä¸­çš„ï¼Œä¿æŒé€‰ä¸­çŠ¶æ€ï¼›å¦åˆ™ä¸é€‰ä¸­
                const isSelected = (item === currentValue) ? 'selected' : '';
                html += `<option value="${item}" ${isSelected}>${item}</option>`;
            }
        });
        selectEl.innerHTML = html;

        // å¦‚æœæ—§å€¼åœ¨æ–°åˆ—è¡¨ä¸­ä¸å­˜åœ¨äº†ï¼ˆè¯´æ˜ä¸åŒ¹é…ï¼‰ï¼Œåˆ™ç½®ç©º
        if (currentValue && !validItems.includes(currentValue)) {
            selectEl.value = "";
        }
    }

    // é‡ç½®ç­›é€‰å™¨
    function resetFilters() {
        // æ¢å¤æ‰€æœ‰åŸå§‹é€‰é¡¹
        updateSelect(document.getElementById('level1_select'), originalOptions.level1.map(opt => opt.value), '');
        updateSelect(document.getElementById('level2_select'), originalOptions.level2.map(opt => opt.value), '');
        updateSelect(document.getElementById('topic_name_select'), originalOptions.names.map(opt => opt.value), '');

        // æäº¤è¡¨å•ï¼ˆé‡ç½®æœç´¢ï¼‰
        document.querySelector('form[action="{{ url_for("topics") }}"]').submit();
    }
</script>
{% endblock %}