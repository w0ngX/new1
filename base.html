<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        /* ä¿®æ”¹ base.html ä¸­çš„ style éƒ¨åˆ† */
        html {
            font-size: 14px; /* Bootstrap é»˜è®¤é€šå¸¸æ˜¯ 16pxï¼Œæ”¹ä¸º 14px ä¼šæ•´ä½“ç¼©å°çº¦ 12% */
        }

        body {
            font-size: 0.85rem; /* è¿›ä¸€æ­¥ç²¾ç»†æ§åˆ¶æ­£æ–‡å­—ä½“ */
            line-height: 1.5;
        }
        body {
            background-color: #f4f6f9;
            overflow-x: hidden;
        }
        :root {
          --primary-color: #2c3e50;
          --secondary-color: #3498db;
          --success-color: #28a745;
          --info-color: #17a2b8;
          --warning-color: #ffc107;
          --danger-color: #dc3545;
          --light-color: #f8f9fa;
          --dark-color: #343a40;
          --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
          --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
          --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
          --radius-sm: 6px;
          --radius-md: 10px;
          --radius-lg: 16px;
        }
        /* --- ä¾§è¾¹æ æ ·å¼ä¿®æ”¹ --- */
        .sidebar {
            /* å…³é”®ä¿®æ”¹ï¼šé«˜åº¦é”å®šä¸ºè§†çª—é«˜åº¦ï¼Œä¸”å›ºå®šåœ¨é¡¶éƒ¨ */
            height: 100vh;
            position: sticky;
            top: 0;
            width: 270px;
            background-color: #2c3e50; /* åˆå¤œè“ */
            box-shadow: 2px 0 6px rgba(0,0,0,0.1);
            padding-top: 20px;
            /* å…³é”®ï¼šè®©å†…éƒ¨å…ƒç´ å¯ä»¥æ»šåŠ¨ï¼Œä½†ä¾§è¾¹æ æœ¬èº«ä¸åŠ¨ */
            overflow-y: auto;
            /* éšè—ä¾§è¾¹æ æ»šåŠ¨æ¡(ç¾è§‚) */
            scrollbar-width: none;
        }
        .sidebar-header {
            padding: 00px;
            font-size: 1rem; /* é™ä½æ ‡é¢˜å¤§å° */
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
            overflow: hidden;    /* è¶…å‡ºéƒ¨åˆ†éšè— */
            text-overflow: ellipsis; /* æ˜¾ç¤ºçœç•¥å· */
        }
        .main-container {
            flex: 1;
            /* 2. è¿™é‡Œçš„ margin-left å¿…é¡»å’Œä¸Šé¢çš„ width ä¸€è‡´ */
            margin-left: 300px;
            min-width: 0;
            background-color: #f4f6f9;
            padding: 20px;
        }
        .sidebar::-webkit-scrollbar {
            display: none;
        }

        .sidebar-brand {
            background: rgba(255,255,255,0.05);
            border-radius: var(--radius-md);
            color: #ecf0f1;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .sidebar-brand i {
            color: #3498db;
        }

        .sidebar .nav-link {
            color: #bdc3c7;
            font-size: 1rem;
            padding: 12px 16px;
            margin: 5px 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .sidebar .nav-link i {
            margin-right: 8px;
            font-size: 1.2rem;
            width: 40px;
            text-align: center;
        }

        .sidebar .nav-link:hover {
            color: #fff;
            background-color: #34495e;
            transform: translateX(5px);
        }

        .sidebar .nav-link.active {
            color: #fff;
            background: linear-gradient(45deg, #3498db, #2980b9);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-weight: 500;
        }

        .content-area {
            padding: 30px;
            width: 100%;
        }

        .alert-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        /* å¡ç‰‡ç»Ÿä¸€æ ·å¼ */
        .card {
          border: none;
          border-radius: var(--radius-md);
          box-shadow: var(--shadow-sm);
          transition: transform 0.2s, box-shadow 0.2s;
        }
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="row flex-nowrap">
            <div class="col-auto col-md-3 col-xl-2 px-0 sidebar">
                <div class="d-flex flex-column align-items-center align-items-sm-start px-3 pt-2 text-white h-100">

                    <a href="/" class="d-flex align-items-center pb-3 mb-md-0 me-md-auto text-decoration-none w-100 justify-content-center">
                        <div class="sidebar-brand">
                            <i class="bi bi-database-fill-gear"></i> ææ•°å®æ•°æ®ç®¡ç†ä¸­å¿ƒ
                        </div>
                    </a>

                    <ul class="nav nav-pills flex-column mb-auto w-100" id="menu">
                        <li class="nav-item w-100">
                            <a href="{{ url_for('index') }}" class="nav-link {{ is_active('index') }}">
                                <i class="bi bi-speedometer2"></i> <span class="d-none d-sm-inline">æ€»è§ˆä»ªè¡¨ç›˜</span>
                            </a>

                            <a href="{{ url_for('contracts') }}" class="nav-link {{ is_active('contracts') }}">
                                <i class="bi bi-file-earmark-text"></i> <span class="d-none d-sm-inline"> åˆåŒç®¡ç†</span>
                            </a>

                            <a href="{{ url_for('topics') }}" class="nav-link {{ is_active('topics') }}">
                                <i class="bi bi-tags"></i> <span class="d-none d-sm-inline"> ä¸»é¢˜ç®¡ç†</span>
                            </a>

                            <a href="{{ url_for('tasks') }}" class="nav-link {{ is_active('tasks') }}">
                                <i class="bi bi-list-check"></i> <span class="d-none d-sm-inline"> æœåŠ¡å†…å®¹ç®¡ç†</span>
                            </a>

                            <a href="{{ url_for('service_mapping') }}" class="nav-link {{ 'active' if request.endpoint == 'service_mapping' else '' }}">
                                <i class="bi bi-diagram-3"></i> å¯¹åº”å…³ç³»é€è§†
                            </a>

                            <a  href="{{ url_for('task_management') }}" class="nav-link {{ is_active('task_management') }}">
                                <i class="bi bi-activity"></i> ä»»åŠ¡ç®¡ç†
                            </a>
                        </li>

                    </ul>

                    <div class="dropdown pb-4 ps-3 mt-auto w-100">
                        <hr style="border-color: rgba(255,255,255,0.1);">
                        <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center text-white me-2" style="width: 32px; height: 32px;">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <span class="d-none d-sm-inline">
                                {% if current_user.is_authenticated %}
                                    {{ current_user.username }}
                                {% else %}
                                    æœªç™»å½•
                                {% endif %}
                            </span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                            <li><a class="dropdown-item" href="#">è®¾ç½®</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">é€€å‡ºç™»å½•</a></li>
                        </ul>
                    </div>

                </div>
            </div>

            <div class="col py-3 content-area">
                {% with messages = get_flashed_messages(with_categories=true) %}
                  {% if messages %}
                    <div class="alert-container">
                    {% for category, message in messages %}
                      <div class="alert alert-{{ category }} alert-dismissible fade show alert-message" role="alert">
                        <strong>æç¤ºï¼š</strong> {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                      </div>
                    {% endfor %}
                    </div>
                  {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<div id="aiFloatingBall"
     style="position: fixed; bottom: 100px; right: 20px; z-index: 9999; cursor: move; touch-action: none; user-select: none;">
    <button class="btn btn-primary rounded-circle shadow-lg p-0 d-flex align-items-center justify-content-center"
            style="width: 60px; height: 60px; border: 2px solid white;">
        <span style="font-size: 30px;">ğŸ¤–</span>
    </button>
</div>

<div id="aiChatBox" class="card shadow-lg"
     style="position: fixed; bottom: 90px; right: 90px; width: 350px; height: 500px; display: none; z-index: 9999; flex-direction: column;">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <span>ğŸ¤– æ™ºèƒ½åŠ©æ‰‹</span>
        <div>
            <button class="btn btn-sm btn-outline-light me-1 border-0" onclick="clearChat()" title="æ¸…ç©ºå¯¹è¯">
                <i class="bi bi-eraser"></i>
            </button>
            <button type="button" class="btn-close btn-close-white" onclick="toggleAIChat()"></button>
        </div>
    </div>
    <div class="card-body" id="aiResponseArea" style="overflow-y: auto; flex-grow: 1; background: #f8f9fa;">
        <div class="text-muted small text-center mt-5">æˆ‘æ˜¯æ‚¨çš„æ•°æ®åŠ©æ‰‹<br>è¯·é—®æˆ‘å…³äºåˆåŒã€ä¸»é¢˜æˆ–ä»»åŠ¡çš„é—®é¢˜...</div>
    </div>
    <div class="card-footer p-2">
        <div class="input-group">
            <input type="text" id="aiInput" class="form-control" placeholder="è¾“å…¥é—®é¢˜..." onkeypress="handleEnter(event)">
            <button class="btn btn-primary" onclick="sendAIQuery()">å‘é€</button>
        </div>
    </div>
</div>

<script>
    // --- æ‹–æ‹½é€»è¾‘å¼€å§‹ ---
    const ball = document.getElementById('aiFloatingBall');
    let isDragging = false;
    let hasMoved = false; // ç”¨äºåŒºåˆ†æ˜¯"ç‚¹å‡»"è¿˜æ˜¯"æ‹–æ‹½"
    let startX, startY, initialLeft, initialTop;

    // é¼ æ ‡/æ‰‹æŒ‡æŒ‰ä¸‹
    ball.addEventListener('mousedown', startDrag);
    ball.addEventListener('touchstart', startDrag, {passive: false});

    function startDrag(e) {
        isDragging = true;
        hasMoved = false; // é‡ç½®ç§»åŠ¨æ ‡è®°

        // å…¼å®¹ç§»åŠ¨ç«¯å’ŒPCç«¯è·å–åæ ‡
        const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

        startX = clientX;
        startY = clientY;

        // è·å–å…ƒç´ å½“å‰ä½ç½®
        const rect = ball.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;

        // ç»‘å®šç§»åŠ¨å’Œæ¾å¼€äº‹ä»¶åˆ° windowï¼Œé˜²æ­¢æ‹–å¤ªå¿«è„±ç¦»å…ƒç´ 
        window.addEventListener('mousemove', onDrag);
        window.addEventListener('touchmove', onDrag, {passive: false});
        window.addEventListener('mouseup', stopDrag);
        window.addEventListener('touchend', stopDrag);
    }

    function onDrag(e) {
        if (!isDragging) return;

        const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

        // è®¡ç®—ç§»åŠ¨è·ç¦»
        const dx = clientX - startX;
        const dy = clientY - startY;

        // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡ 5pxï¼Œåˆ™è§†ä¸ºæ‹–æ‹½ï¼Œè€Œä¸æ˜¯è¯¯è§¦
        if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
            hasMoved = true;
        }

        // é˜»æ­¢ç§»åŠ¨ç«¯é»˜è®¤çš„æ»šåŠ¨è¡Œä¸º
        if (e.type === 'touchmove') {
            e.preventDefault();
        }

        // è®¡ç®—æ–°ä½ç½®
        let newLeft = initialLeft + dx;
        let newTop = initialTop + dy;

        // é™åˆ¶åœ¨å±å¹•èŒƒå›´å†… (é˜²æ­¢æ‹–å‡ºå»å›ä¸æ¥)
        const maxLeft = window.innerWidth - ball.offsetWidth;
        const maxTop = window.innerHeight - ball.offsetHeight;

        newLeft = Math.max(0, Math.min(newLeft, maxLeft));
        newTop = Math.max(0, Math.min(newTop, maxTop));

        // åº”ç”¨æ–°ä½ç½®
        ball.style.left = newLeft + 'px';
        ball.style.top = newTop + 'px';
        ball.style.right = 'auto';  // æ¸…é™¤ right å±æ€§ï¼Œå¦åˆ™ left ä¸ç”Ÿæ•ˆ
        ball.style.bottom = 'auto'; // æ¸…é™¤ bottom å±æ€§
    }

    function stopDrag() {
        isDragging = false;
        // ç§»é™¤ç›‘å¬
        window.removeEventListener('mousemove', onDrag);
        window.removeEventListener('touchmove', onDrag);
        window.removeEventListener('mouseup', stopDrag);
        window.removeEventListener('touchend', stopDrag);
    }

    // ç»‘å®šç‚¹å‡»äº‹ä»¶ (æ ¸å¿ƒé€»è¾‘ï¼šåªæœ‰æ²¡æ‹–æ‹½è¿‡ï¼Œæ‰ç®—ç‚¹å‡»)
    ball.addEventListener('click', function(e) {
        if (!hasMoved) {
            toggleAIChat();
        }
    });
    // --- æ‹–æ‹½é€»è¾‘ç»“æŸ ---


    // --- èŠå¤©æ¡†ä¸šåŠ¡é€»è¾‘ ---
    function toggleAIChat() {
        const box = document.getElementById('aiChatBox');
        // ç®€å•çš„æ˜¾ç¤º/éšè—åˆ‡æ¢
        if (box.style.display === 'none' || box.style.display === '') {
            box.style.display = 'flex';

            // æ™ºèƒ½å®šä½ï¼šå¦‚æœæ‚¬æµ®çƒåœ¨å³è¾¹ï¼ŒèŠå¤©æ¡†åœ¨å·¦è¾¹ï¼›åä¹‹äº¦ç„¶
            const ballRect = ball.getBoundingClientRect();
            const boxWidth = 350;
            const boxHeight = 500;

            // é»˜è®¤æ˜¾ç¤ºåœ¨çƒçš„å·¦ä¾§
            let leftPos = ballRect.left - boxWidth - 10;
            // å¦‚æœå·¦è¾¹ç©ºé—´ä¸å¤Ÿï¼Œå°±æ˜¾ç¤ºåœ¨çƒçš„å³ä¾§
            if (leftPos < 10) {
                leftPos = ballRect.right + 10;
            }

            // å‚ç›´æ–¹å‘åº•éƒ¨å¯¹é½
            let topPos = ballRect.bottom - boxHeight;
            // é˜²æ­¢é¡¶éƒ¨è¶…å‡ºå±å¹•
            if (topPos < 10) topPos = 10;
            // é˜²æ­¢åº•éƒ¨è¶…å‡ºå±å¹•
            if (topPos + boxHeight > window.innerHeight) topPos = window.innerHeight - boxHeight - 10;

            box.style.left = leftPos + 'px';
            box.style.top = topPos + 'px';
            box.style.right = 'auto';
            box.style.bottom = 'auto';

            document.getElementById('aiInput').focus();
        } else {
            box.style.display = 'none';
        }
    }

    function clearChat() {
        document.getElementById('aiResponseArea').innerHTML = '<div class="text-muted small text-center mt-5">å¯¹è¯å·²æ¸…ç©º</div>';
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendAIQuery();
    }

    // å‘é€è¯·æ±‚ (æµå¼å“åº”ç‰ˆ)
    async function sendAIQuery() {
        const input = document.getElementById('aiInput');
        const output = document.getElementById('aiResponseArea');
        const query = input.value.trim();

        if (!query) return;

        input.value = '';
        output.innerHTML += `<div class="d-flex justify-content-end mb-2"><div class="bg-primary text-white p-2 rounded" style="max-width: 80%;">${query}</div></div>`;

        const aiBubbleId = 'ai-' + Date.now();
        output.innerHTML += `<div class="d-flex justify-content-start mb-2"><div id="${aiBubbleId}" class="bg-white border p-2 rounded shadow-sm" style="max-width: 80%;">Thinking...</div></div>`;
        const aiBubble = document.getElementById(aiBubbleId);
        output.scrollTop = output.scrollHeight;

        try {
            const response = await fetch('/api/ai_query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let aiText = "";
            aiBubble.innerHTML = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonStr = line.slice(6);
                        if (jsonStr.trim() === '[DONE]') break;
                        try {
                            const data = JSON.parse(jsonStr);
                            if (data.text) {
                                aiText += data.text;
                                aiBubble.innerHTML = aiText.replace(/\n/g, '<br>');
                                output.scrollTop = output.scrollHeight;
                            }
                        } catch (e) { console.error(e); }
                    }
                }
            }
        } catch (err) {
            aiBubble.innerHTML += `<br><span class="text-danger">å‡ºé”™: ${err.message}</span>`;
        }
    }
</script>